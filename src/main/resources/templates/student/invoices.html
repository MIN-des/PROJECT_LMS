<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>등록금 고지서</title>
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css"/>
</head>
<body>
<div class="container mt-5">
  <h1 class="text-center">등록금 고지서</h1>

  <div th:if="${invoices != null && invoices.size() > 0}">
    <table class="table table-bordered mt-4">
      <thead>
      <tr>
        <th>파일명</th>
        <th>학번</th>
        <th>학생 이름</th>
        <th>업로드 날짜</th>
        <th>다운로드</th>
        <th>미리보기</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="invoice : ${invoices}">
        <td th:text="${invoice.fileName}"></td>
        <td th:text="${invoice.sId}"></td>
        <td th:text="${invoice.sName}"></td>
        <td th:text="${#temporals.format(invoice.uploadDate, 'yyyy-MM-dd HH:mm')}"></td>
        <td>
          <a th:href="@{'/student/invoices/download/' + ${invoice.tId}}" class="btn btn-success btn-sm">다운로드</a>
        </td>
        <td>
          <button class="btn btn-primary btn-sm" th:attr="data-id=${invoice.tId}, data-file-name=${invoice.fileName}" onclick="previewInvoiceFromData(this)">미리보기</button>
        </td>

      </tr>
      </tbody>
    </table>
  </div>

  <div th:if="${invoices == null || invoices.size() == 0}" class="alert alert-info mt-4">
    등록금 고지서가 없습니다.
  </div>

  <!-- PDF 미리보기 영역 -->
  <div id="preview-container" class="mt-4" style="display: none;">
    <iframe id="preview-frame" src="" style="width: 100%; height: 600px;" frameborder="0"></iframe>
  </div>
</div>

<script>
  function previewInvoiceFromData(button) {
    const tId = button.getAttribute('data-id'); // data-id에서 tId를 가져옴

    if (!tId || isNaN(tId)) {
      console.error("Invalid tId:", tId);
      alert("유효하지 않은 고지서 ID입니다.");
      return;
    }
    previewInvoice(tId); // 미리보기 함수 호출
  }

  function previewInvoice(tId) {
    if (!tId) {
      console.error("Invalid tId:", tId);
      return;
  }

  // PDF 미리보기 URL 생성
  const previewUrl = `/student/invoices/preview/${tId}`;

  // iframe에 PDF URL 설정
  const iframe = document.getElementById('preview-frame');
  if (iframe) {
      iframe.src = previewUrl;
    } else {
      console.error("Preview frame not found");
  }

    // 미리보기 컨테이너 보이기
  const previewContainer = document.getElementById('preview-container');
    if (previewContainer) {
      previewContainer.style.display = 'block';
    } else {
      console.error("Preview container not found");
    }
  }
</script>

<script src="/assets/js/bootstrap.bundle.min.js"></script>
</body>
</html>
